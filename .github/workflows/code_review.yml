name: Code Quality and AI Review

on:
  push:
    branches:
      - main
  pull_request:
    branches: [ main ] # Ajouté pour tester les PRs aussi

jobs:
  review:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        # Fetch the previous commit to compare changes
        fetch-depth: 2 

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11' # Changement à 3.11 pour une meilleure compatibilité

    - name: Install dependencies (Linters, Type Checkers et Scripts)
      run: pip install -r requirements.txt

    # ⬇️ NOUVELLE ÉTAPE 1 : VÉRIFICATION DU TYPAGE (MYPY) ⬇️
    - name: Type Checking with Mypy
      # Utilise '|| true' pour que le workflow continue en cas d'erreurs
      # (Ceci est essentiel car nous voulons que le script IA analyse les erreurs de Mypy et Flake8)
      run: mypy main_script.py || true
      id: mypy_check 
      
    # ⬇️ NOUVELLE ÉTAPE 2 : VÉRIFICATION DU STYLE (FLAKE8) ⬇️
    - name: Style Check with Flake8
      # Utilise '|| true' pour capturer les erreurs sans bloquer
      run: flake8 main_script.py || true
      id: flake8_check

    # L'étape IA s'exécute MAINTENANT même si Mypy/Flake8 échoue, car elle en a besoin.
    - name: Run Code Review Script
      env:
        # Les secrets doivent être configurés dans les paramètres GitHub du dépôt
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
        SENDER_EMAIL: ${{ secrets.SENDER_EMAIL }}
      run: |
        # 1. Récupérer l'e-mail du committer (développeur à notifier)
        COMMIT_AUTHOR_EMAIL=$(git log -1 --pretty=format:'%ae')
        
        # 2. Déterminer les fichiers Python changés
        # Cela s'assure que nous n'analysons que les fichiers .py modifiés
        CHANGED_FILES=$(git diff --name-only HEAD^ HEAD | grep '\.py$')
        
        # 3. Exécuter le script Python pour analyser et notifier
        # Le script analyse les fichiers changés et envoie le rapport via l'IA
        python analyze_and_notify.py "$COMMIT_AUTHOR_EMAIL" "$CHANGED_FILES"