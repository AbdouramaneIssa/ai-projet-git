name: Code Review and Notification

on:
  push:
    branches:
      - '**'

jobs:
  review:
    runs-on: ubuntu-latest

    steps:
    # --- Étape 1 : Cloner le dépôt ---
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 2  # Nécessaire pour comparer les deux derniers commits

    # --- Étape 2 : Installer Python ---
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'
        cache: 'pip'
        cache-dependency-path: requirements.txt

    # --- Étape 3 : Vérifier l'existence du fichier requirements.txt ---
    - name: Check for requirements.txt
      run: |
        if [ ! -f requirements.txt ]; then
          echo "google-genai" > requirements.txt
          echo "mypy" >> requirements.txt
          echo "flake8" >> requirements.txt
        fi

    # --- Étape 4 : Installer les dépendances ---
    - name: Install dependencies
      run: pip install -r requirements.txt

    # --- Étape 5 : Vérification du style avec Flake8 ---
    - name: Run Flake8 (Style Check)
      run: |
        echo "Exécution de Flake8..."
        flake8 . || (echo "❌ Flake8 a détecté des problèmes de style." && exit 1)

    # --- Étape 6 : Vérifier que le script Python existe ---
    - name: Check for analyze_and_notify.py
      run: |
        if [ ! -f analyze_and_notify.py ]; then
          echo "Erreur : analyze_and_notify.py est introuvable."
          exit 1
        fi

    # --- Étape 7 : Lancer le script principal d'analyse et de notification ---
    - name: Run Code Review and Mypy Verification Script
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
        SENDER_EMAIL: ${{ secrets.SENDER_EMAIL }}
      run: |
        if [ -z "$GEMINI_API_KEY" ] || [ -z "$GMAIL_APP_PASSWORD" ] || [ -z "$SENDER_EMAIL" ]; then
          echo "Erreur : Une variable secrète est manquante."
          exit 1
        fi

        COMMIT_AUTHOR_EMAIL=$(git log -1 --pretty=format:'%ae')
        CHANGED_FILES=$(git diff-tree --no-commit-id --name-only -r HEAD)
        echo "Auteur du commit : $COMMIT_AUTHOR_EMAIL"
        echo "Fichiers modifiés : $CHANGED_FILES"

        python analyze_and_notify.py "$COMMIT_AUTHOR_EMAIL" "$CHANGED_FILES"
