name: Code Quality and AI Review

on:
  push:
    branches:
      - main
  pull_request:
    branches: [ main ]

jobs:
  review:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 2 

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies (Linters, Type Checkers et Scripts)
      run: pip install -r requirements.txt

    # NOUVELLE ÉTAPE 1 : VÉRIFICATION DU TYPAGE (MYPY)
    - name: Type Checking with Mypy
      run: mypy main_script.py || true
      id: mypy_check 

    # NOUVELLE ÉTAPE 2 : VÉRIFICATION DU STYLE (FLAKE8)
    - name: Style Check with Flake8
      run: flake8 main_script.py || true
      id: flake8_check

    - name: Run Code Review Script
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
        SENDER_EMAIL: ${{ secrets.SENDER_EMAIL }}
      run: |
        COMMIT_AUTHOR_EMAIL=$(git log -1 --pretty=format:'%ae')
        CHANGED_FILES=$(git diff --name-only HEAD^ HEAD | grep '\.py$')
        python analyze_and_notify.py "$COMMIT_AUTHOR_EMAIL" "$CHANGED_FILES"